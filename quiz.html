<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HUM203 Quiz</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="py-4 bg-body">
  <div class="container-sm">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="fs-5 fw-bold text-accent mb-0">HUM203 Anthropology Quiz</h1>
        <div id="chapterTitle" class="small text-secondary">Select a chapter to begin</div>
      </div>
      <button id="themeToggle" class="btn btn-sm btn-outline-secondary">Switch to Light Mode</button>
    </div>

    <div id="chapterSelector" class="mb-4"></div>
    <div id="questionNav" class="mb-3 d-flex flex-wrap gap-2"></div>
    <div id="progressSummary" class="mb-3 fw-semibold text-accent"></div>
    <div id="quiz"></div>
    <div id="finalScore" class="alert d-none mt-4 text-center"></div>

    <div class="text-center mt-4">
      <button class="btn btn-outline-secondary" id="restartBtn">Back to Chapters</button>
      <a href="index.html" class="btn btn-outline-secondary ms-2">Home</a>
    </div>
  </div>

  <script>
    const html = document.documentElement;
    const themeToggle = document.getElementById("themeToggle");

    // theme from localStorage
    const savedTheme = localStorage.getItem("theme") || "dark";
    html.setAttribute("data-bs-theme", savedTheme);
    themeToggle.textContent = savedTheme === "dark" ? "Switch to Light Mode" : "Switch to Dark Mode";

    themeToggle.addEventListener("click", () => {
      const current = html.getAttribute("data-bs-theme") || "dark";
      const next = current === "dark" ? "light" : "dark";
      html.setAttribute("data-bs-theme", next);
      localStorage.setItem("theme", next);
      themeToggle.textContent = next === "dark" ? "Switch to Light Mode" : "Switch to Dark Mode";
    });

    const quizContainer = document.getElementById("quiz");
    const questionNav = document.getElementById("questionNav");
    const progressSummary = document.getElementById("progressSummary");
    const finalScoreDiv = document.getElementById("finalScore");
    const restartBtn = document.getElementById("restartBtn");
    const chapterSelectorDiv = document.getElementById("chapterSelector");
    const chapterTitleDiv = document.getElementById("chapterTitle");

    let allChapters = [];
    let currentChapter = null;
    let questions = [];
    let current = 0;
    let answers = [];
    let states = [];

    async function loadChapters() {
      try {
        const res = await fetch("questions.json");
        allChapters = await res.json();
        renderChapterSelect();
      } catch (err) {
        chapterSelectorDiv.innerHTML = `<div class="text-danger">Error loading questions.json</div>`;
      }
    }

    function renderChapterSelect() {
      quizContainer.innerHTML = "";
      finalScoreDiv.classList.add("d-none");
      progressSummary.textContent = "";
      questionNav.innerHTML = "";

      chapterSelectorDiv.classList.remove("d-none");
      chapterTitleDiv.textContent = "Select a chapter to begin";

      chapterSelectorDiv.innerHTML = `
        <label class="form-label fw-semibold">Choose a Chapter:</label>
        <div class="input-group">
          <select id="chapterSelect" class="form-select">
            ${allChapters.map((c, i) => `<option value="${i}">${c.chapter}</option>`).join("")}
          </select>
          <button class="btn btn-accent text-light" id="startChapter">Start</button>
        </div>
      `;

      document.getElementById("startChapter").addEventListener("click", () => {
        const idx = parseInt(document.getElementById("chapterSelect").value, 10);
        startChapter(idx);
      });
    }

    function startChapter(index) {
      currentChapter = index;
      questions = allChapters[index].questions || [];
      current = 0;
      answers = [];
      states = [];

      const chapterName = allChapters[index].chapter || "Unknown Chapter";
      chapterTitleDiv.textContent = chapterName;
      chapterTitleDiv.classList.add("fw-bold", "text-uppercase", "mt-2");

      chapterSelectorDiv.classList.add("d-none");
      renderQuestion(0);
      renderNav();
    }

    function renderQuestion(index) {
      current = index;
      const q = questions[index];
      if (!q) {
        quizContainer.innerHTML = `<div class="text-muted">No questions found for this chapter.</div>`;
        return;
      }

      let optionsHtml = "";
      if (q.type === "truefalse") {
        optionsHtml = `
          <div class="form-check mt-2">
            <input class="form-check-input" type="radio" name="q${index}" id="q${index}_t" value="true">
            <label class="form-check-label" for="q${index}_t">True</label>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="radio" name="q${index}" id="q${index}_f" value="false">
            <label class="form-check-label" for="q${index}_f">False</label>
          </div>`;
      } else if (q.type === "multiple") {
        optionsHtml = q.options.map((opt, i) => `
          <div class="form-check mt-2">
            <input class="form-check-input" type="radio" name="q${index}" id="q${index}_${i}" value="${opt.text}">
            <label class="form-check-label" for="q${index}_${i}">${opt.text}</label>
          </div>`).join("");
      }

      quizContainer.innerHTML = `
        <div class="card shadow-sm p-4 mb-4 border-0 bg-surface">
          <h5 class="mb-3">${index + 1}. ${q.text}</h5>
          ${optionsHtml}
          <button class="btn btn-accent text-light mt-4 w-100" id="submitBtn">${index === questions.length - 1 ? "Finish Quiz" : "Next"}</button>
          <div id="result${index}" class="mt-3"></div>
        </div>
      `;

      if (answers[index] !== undefined) {
        const inputs = document.querySelectorAll(`input[name="q${index}"]`);
        inputs.forEach(inp => { if (inp.value === answers[index]) inp.checked = true; });
      }

      document.getElementById("submitBtn").addEventListener("click", () => submitAnswer(index));
      renderNav();
    }

    function submitAnswer(index) {
      const q = questions[index];
      const selected = document.querySelector(`input[name="q${index}"]:checked`);
      const resultDiv = document.getElementById(`result${index}`);

      if (!selected) {
        resultDiv.innerHTML = `<div class="text-danger">Please select an answer.</div>`;
        return;
      }

      let correct = false;
      if (q.type === "truefalse") correct = selected.value === q.answer;
      else if (q.type === "multiple") correct = Array.isArray(q.correct) && q.correct.includes(selected.value);

      states[index] = correct;
      answers[index] = selected.value;

      resultDiv.innerHTML = correct ? `<div class="text-success">✅ Correct!</div>` : `<div class="text-danger">❌ Incorrect.</div>`;
      renderNav();

      setTimeout(() => {
        if (index + 1 < questions.length) renderQuestion(index + 1);
        else showScore();
      }, 700);
    }

    function renderNav() {
      questionNav.innerHTML = questions.map((_, i) => {
        const cls = states[i] === undefined ? 'btn-outline-secondary' : states[i] ? 'btn-success' : 'btn-danger';
        return `<button class="btn ${cls} btn-sm ${i === current ? 'active' : ''}" onclick="navigate(${i})">${i + 1}</button>`;
      }).join('');
      const answered = states.filter(s => s !== undefined).length;
      const correct = states.filter(Boolean).length;
      progressSummary.textContent = `Correct: ${correct} / ${answered} answered`;
    }

    function navigate(i) { renderQuestion(i); }

    function showScore() {
      const score = states.filter(Boolean).length;
      quizContainer.innerHTML = "";
      finalScoreDiv.classList.remove("d-none");
      finalScoreDiv.classList.add("alert-info");
      finalScoreDiv.innerHTML = `<strong>Final Score: ${score} / ${questions.length}</strong>`;
    }

    restartBtn.addEventListener("click", () => renderChapterSelect());
    loadChapters();
  </script>
</body>
</html>
